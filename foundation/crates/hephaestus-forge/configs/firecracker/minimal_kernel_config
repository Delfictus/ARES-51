# Minimal Linux Kernel Configuration for Firecracker VM
# Optimized for <50ms boot time and maximum security isolation
# Based on Linux 6.1+ with minimal attack surface

CONFIG_64BIT=y
CONFIG_X86_64=y
CONFIG_SMP=y

# Essential kernel features
CONFIG_MODULES=n
CONFIG_MODULE_UNLOAD=n
CONFIG_KALLSYMS=n
CONFIG_PROC_FS=y
CONFIG_SYSFS=y
CONFIG_TMPFS=y
CONFIG_DEVTMPFS=y

# Memory management - hardened
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_STRICT_MODULE_RWX=y
CONFIG_PAGE_POISONING=y
CONFIG_PAGE_POISONING_NO_SANITY=y
CONFIG_PAGE_POISONING_ZERO=y
CONFIG_SLAB_FREELIST_RANDOM=y
CONFIG_SLAB_FREELIST_HARDENED=y
CONFIG_SHUFFLE_PAGE_ALLOCATOR=y

# Disable debugging for performance
CONFIG_DEBUG_KERNEL=n
CONFIG_DEBUG_INFO=n
CONFIG_FRAME_POINTER=n
CONFIG_STACK_VALIDATION=n
CONFIG_DEBUG_STACKOVERFLOW=n

# Essential I/O
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y
CONFIG_VIRTIO=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_MMIO=y
CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_NET=y
CONFIG_VIRTIO_CONSOLE=y

# File systems - minimal
CONFIG_EXT4_FS=y
CONFIG_EXT4_USE_FOR_EXT2=y
CONFIG_EXT4_FS_POSIX_ACL=y
CONFIG_EXT4_FS_SECURITY=y
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y

# Network - minimal required
CONFIG_INET=y
CONFIG_IP_ADVANCED_ROUTER=n
CONFIG_IP_MULTIPLE_TABLES=n
CONFIG_NETFILTER=y
CONFIG_NETFILTER_ADVANCED=n

# Security hardening
CONFIG_SECURITY=y
CONFIG_SECURITY_SELINUX=n
CONFIG_SECURITY_SMACK=n
CONFIG_SECURITY_APPARMOR=n
CONFIG_DEFAULT_SECURITY_DAC=y
CONFIG_LSM=""

# Disable unnecessary features for attack surface reduction
CONFIG_ACPI=n
CONFIG_CPU_FREQ=n
CONFIG_PCCARD=n
CONFIG_CARDBUS=n
CONFIG_YENTA=n
CONFIG_HOTPLUG=n
CONFIG_USB_SUPPORT=n
CONFIG_SOUND=n
CONFIG_FB=n
CONFIG_DRM=n
CONFIG_STAGING=n
CONFIG_X86_PLATFORM_DEVICES=n

# Disable containers/namespaces (we rely on Firecracker isolation)
CONFIG_NAMESPACES=n
CONFIG_USER_NS=n
CONFIG_PID_NS=n
CONFIG_NET_NS=n
CONFIG_UTS_NS=n
CONFIG_IPC_NS=n
CONFIG_MNT_NS=n
CONFIG_CGROUPS=n

# Disable loadable modules completely
CONFIG_MODULES=n

# Minimal timer support
CONFIG_NO_HZ_IDLE=y
CONFIG_HIGH_RES_TIMERS=y

# Essential for boot
CONFIG_ELF_CORE=y
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_SCRIPT=y

# Hardening options
CONFIG_RANDOMIZE_BASE=y
CONFIG_RANDOMIZE_MEMORY=y
CONFIG_LEGACY_VSYSCALL_NONE=y
CONFIG_PAGE_TABLE_ISOLATION=y
CONFIG_RETPOLINE=y
CONFIG_SLS=y

# Disable COMPAT for 32-bit (attack surface reduction)
CONFIG_COMPAT=n
CONFIG_IA32_EMULATION=n

# Minimal power management
CONFIG_PM=n
CONFIG_ACPI=n

# Essential for Firecracker
CONFIG_PARAVIRT=y
CONFIG_KVM_GUEST=y
CONFIG_HYPERVISOR_GUEST=y

# Hardware RNG for security
CONFIG_HW_RANDOM=y
CONFIG_HW_RANDOM_VIRTIO=y

# Minimal crypto
CONFIG_CRYPTO=y
CONFIG_CRYPTO_HASH=y
CONFIG_CRYPTO_MANAGER=y
CONFIG_CRYPTO_SHA256=y
CONFIG_CRYPTO_AES=y

# Performance optimizations
CONFIG_PREEMPT=y
CONFIG_PREEMPT_COUNT=y
CONFIG_TREE_RCU=y
CONFIG_RCU_FANOUT=32

# Essential for basic operation
CONFIG_FUTEX=y
CONFIG_EPOLL=y
CONFIG_SIGNALFD=y
CONFIG_TIMERFD=y
CONFIG_EVENTFD=y

# Minimal network stack
CONFIG_PACKET=y
CONFIG_UNIX=y
CONFIG_INET=y
CONFIG_IPV6=n

# Security: Disable unnecessary syscalls
CONFIG_SYSVIPC=n
CONFIG_POSIX_MQUEUE=n
CONFIG_CROSS_MEMORY_ATTACH=n
CONFIG_USELIB=n
CONFIG_AUDIT=n

# Essential for sandboxed execution
CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y
CONFIG_HAVE_ARCH_SECCOMP_FILTER=y

# Memory protection
CONFIG_STRICT_DEVMEM=y
CONFIG_IO_STRICT_DEVMEM=y

# Disable legacy and unused features
CONFIG_LEGACY_PTYS=n
CONFIG_DEVKMEM=n
CONFIG_LEGACY_VSYSCALL_EMULATE=n
CONFIG_MODIFY_LDT_SYSCALL=n
CONFIG_X86_VSYSCALL_EMULATION=n

# Essential init
CONFIG_EMBEDDED=y
CONFIG_EXPERT=y